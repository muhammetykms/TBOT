{% extends "tepe.html" %}

{% block title %}
T-ERP Stratejiler
{% endblock %}

{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dist/custom.css' %}">
{% block sayfabasligi %}

{% endblock %}

{% block sagustmap %}
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Ä°ÅžLEM AÃ‡</a></li>
{% endblock %}

{% block content %}

    <h1><b>STRATEJÄ°LER!</b></h1>

<div class="card card-success">
    <div class="card-header">
        <h3 class="card-title"><b>Strateji Parametreleri TanÄ±mlayÄ±n</b></h3> 
    </div>
    <div class="card-body">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title"><b>Strateji Bilgileri</b></h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label for="" class="fw-bold">Strateji adÄ±</label>
                            <input type="text" name="" class="form-control" value="{{strateji.adi}}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="" class="fw-bold">Strateji AÃ§Ä±klamasÄ±</label>
                            <input type="text" name="" class="form-control" value="{{strateji.aciklama}}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form action="" method="POST" id="genel_form">
            <input type="hidden" id="strateji_id" name="strateji_id" value="{{ strateji.id }}">
            {% csrf_token %}

            <div class="hata-goster">hata gÃ¶ster kÄ±smÄ± : <span>strateji.id: {{ strateji.id }}</span> </div>
            <br>

            <div class="pre-buy-bolumu mb-4">
                <h4 class="text-warning">ðŸŸ¡ <b>Pre-Buy SÃ¼reci</b></h4>
                <div id="pre_buy_container"></div>

                <!-- BurayÄ± d-flex ile ortaladÄ±k: -->
                <div class="d-flex justify-content-center mt-2">

                    <button class="btn btn-success if_ve_btn"
                        hx-get="/stratejiler/if-blogu-ekle/{{ strateji.id }}/"
                        hx-target="#pre_buy_container"
                        hx-swap="beforeend">
                        + VE SatÄ±rÄ±
                    </button>
                
                    <button class="btn btn-warning mr-3 grup-ekle" data-baglanti="VEYA">veya SatÄ±rÄ± Ekle</button>
                    <button class="btn btn-danger">Aksiyon Ekle</button>
                </div>
            </div>

            <div class="inside-buy-bolumu mb-4">
                <h4 class="text-success">ðŸŸ¢ Inside-Buy SÃ¼reci</h4>
                <div id="inside_buy_container">


                    <div class="itema">1</div>
                    <div class="itema">2</div>
                    <div class="itema">3</div>

                  

                </div>
                <div class="btn-group mt-2 justify-content-center"></div>
            </div>

            <div class="after-sell-bolumu mb-4">
                <h4 class="text-primary">ðŸ”µ After-Sell SÃ¼reci</h4>
                <div id="after_sell_container"></div>
                <div class="btn-group mt-2 justify-content-center"></div>
            </div>
        </form>
    </div>



    <div class="card-footer d-flex align-items-center">
        <a href="#" class="btn btn-success" id="gonder-buton">GÃ¶nder</a>
    </div>
</div>

{% endblock %}

{% block footer %}
<p>My custom footer for this page.</p>

<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
<script src="{% static 'dist/js/myLib.js' %}"></script>






























<!-- csrf -->
<script>
  document.body.addEventListener('htmx:configRequest', (event) => {
    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    event.detail.headers['X-CSRFToken'] = token;
  });
</script>


<!-- select2 ile pim seÃ§imi -->
<script>
  function yenidenSelect2Baslat() {
    $('.parite-select').each(function(index) {
      var yeniId = 'pim_' + index;
      $(this).attr('id', yeniId);
      $(this).attr('name', yeniId);

      // EÄŸer select2 zaten varsa destroy edip yeniden kur
      if ($(this).hasClass("select2-hidden-accessible")) {
        $(this).select2('destroy');
      }

      $(this).select2();

      // Sadece bir seÃ§im iÃ§in Ã¶nceki davranÄ±ÅŸÄ± uygula
      $(this).on('select2:select', function (e) {
        var selectedValues = $(this).val();
        if (selectedValues && selectedValues.length > 1) {
          var newSelection = e.params.data.id;
          $(this).val([newSelection]).trigger('change');
        }
      });
    });
  }

  // Sayfa yÃ¼klendiÄŸinde baÅŸlat
  $(function () {
    yenidenSelect2Baslat();
  });

  // HTMX ile yeni blok geldiÄŸinde de baÅŸlat
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.id === "if_bloglari_alani") {
      yenidenSelect2Baslat();
    }
  });
</script>


















<!-- sayfa yÃ¼klendiÄŸinde gelen if iÃ§in parametre ekleme alanÄ± -->
<script>
    function setupIndikatorSelect(select) {
        select.addEventListener("change", function () {
            const selectedId = this.value;
            const indikatorName = this.getAttribute("name"); // Ã¶rnek: ind_0
    
            const container = this.closest(".form-group")?.parentElement?.parentElement;
    
            const parametreDiv = container.querySelector(".parametre-alani");
            const sonucSecimiDiv = container.querySelector(".sonuc-secimi");  // ðŸ‘ˆ dÃ¼zeltildi
    
            if (selectedId && parametreDiv) {
                const url = `/stratejiler/indikator_parametre_partial/${selectedId}/`;
    
                htmx.ajax('GET', url, {
                    target: parametreDiv,
                    swap: 'innerHTML',
                    headers: { 'HX-Trigger': 'parametre_geldi' }
                });
    
                // Ã‡Ä±ktÄ± select alanÄ± da varsa name ayarla
                if (sonucSecimiDiv) {
                    const selectCikti = sonucSecimiDiv.querySelector("select");
                    if (selectCikti) {
                        selectCikti.setAttribute("name", `${indikatorName}__cikti`);
                    }
                }
            }
    
            // HTMX iÃ§erik geldikten sonra parametreleri yeniden adlandÄ±rmak iÃ§in event dinle
            document.body.addEventListener("htmx:afterSwap", function (e) {
                if (e.detail.elt === parametreDiv && indikatorName) {
                    const inputs = parametreDiv.querySelectorAll("input");
                    inputs.forEach((input, index) => {
                    let paramLabel = "param";
                    
                    // input'a karÅŸÄ±lÄ±k gelen label'Ä± bul
                    const label = parametreDiv.querySelector(`label[for="${input.name}"]`);
                    if (label) {
                        const temizAd = label.innerText.trim().toLowerCase().replace(/\s+/g, "_");
                        paramLabel = `param_${index}_${temizAd}`;
                    } else {
                        paramLabel = `param_${index}`;
                    }

                    input.name = `${indikatorName}__${paramLabel}`;
                });

    
                    // EÄŸer Ã§Ä±ktÄ± select HTMX ile geliyorsa, onu da burada adlandÄ±r
                    const ciktiSelect = container.querySelector(".sonuc-secimi");
                    if (ciktiSelect) {
                        ciktiSelect.setAttribute("name", `${indikatorName}__cikti`);
                    }
                }
            });
        });
    }
    
    function initTÃ¼mIndikatorSelectler() {
        document.querySelectorAll(".indikator-select").forEach(function (select) {
            if (!select.dataset.bound) {
                setupIndikatorSelect(select);
                select.dataset.bound = "true";
            }
        });
    }
    
    document.addEventListener("DOMContentLoaded", function () {
        initTÃ¼mIndikatorSelectler();
    });
    
    document.body.addEventListener("htmx:afterSwap", function () {
        initTÃ¼mIndikatorSelectler();
    });
</script>

<!-- ve_if_blogu_ekle_btn, veya_if_blogu_ekle_btn ekleme -->
<script>
function getActiveContainerId() {
    return $('#surec_grubu_sec').val();
}

// VE Grubu Ekle genel
$(document).on('click', '.ve-grubu-ekle', function(e) {
    e.preventDefault();
    var containerId = getActiveContainerId();
    // htmx ile backend'den yeni VE grubu HTMLâ€™i Ã§ek ve ilgili konteynerin sonuna ekle
    htmx.ajax('GET', '/stratejiler/ve_grubu_ekle/', {
        target: document.getElementById(containerId),
        swap: 'beforeend'
    });
    setTimeout(guncelleBlokIdleri, 50);
});

// VEYA Grubu Ekle genel
$(document).on('click', '.veya-grubu-ekle', function(e) {
    e.preventDefault();
    var containerId = getActiveContainerId();
    var newBlokId = getNextBlokId();
    htmx.ajax('GET', '/stratejiler/veya_grubu_ekle/?blok_id'+newBlokId, {
        target: document.getElementById(containerId),
        swap: 'beforeend'
    });
    setTimeout(guncelleBlokIdleri, 50);
});

// alt veya grubu ekleme 
$(document).on('click', '.veya-grubu-ekle', function(e) {
    e.preventDefault();
    var targetId = $(this).data('target-id');
    var container = document.getElementById(targetId);
    var newBlokId = getNextBlokId();
    if (container) {
        htmx.ajax('GET', '/stratejiler/veya_grubu_ekle/?blok_id=' + newBlokId, {
            target: container,
            swap: 'beforeend'
        });
    }
    setTimeout(guncelleBlokIdleri, 50);

});


// blok id gÃ¼ncelleme
function guncelleBlokIdleri() {
    let sayac = 1000;

    // VE gruplarÄ±nÄ± sÄ±rayla gez
    document.querySelectorAll('.ve-grubu').forEach(function(veGrubu) {
        sayac++;
        veGrubu.setAttribute('data-blok-id', sayac);
        veGrubu.id = 've-grubu_' + sayac;

        // VE grubunun altÄ±ndaki if-bloklar-containerâ€™Ä± gÃ¼ncelle
        let ifContainer = veGrubu.querySelector('.ve-if-bloklar-container');
        if (ifContainer) {
            ifContainer.setAttribute('data-blok-id', sayac);
            ifContainer.id = 've-if-bloklar-container_' + sayac;
        }
    });

    // VEYA gruplarÄ±nÄ± sÄ±rayla gez
    document.querySelectorAll('.veya-grubu').forEach(function(veyaGrubu) {
        sayac++;
        veyaGrubu.setAttribute('data-blok-id', sayac);
        veyaGrubu.id = 'veya-grubu_' + sayac;

        // Sol ve saÄŸ containerâ€™larÄ± gÃ¼ncelle
        let sol = veyaGrubu.querySelector('.if-bloklar-container-sol');
        if (sol) {
            sol.setAttribute('data-blok-id', sayac);
            sol.id = 'if-bloklar-container-sol_' + sayac;
        }
        let sag = veyaGrubu.querySelector('.if-bloklar-container-sag');
        if (sag) {
            sag.setAttribute('data-blok-id', sayac);
            sag.id = 'if-bloklar-container-sag_' + sayac;
        }

        // ButonlarÄ±n data-target-idâ€™sini de gÃ¼ncelle
        veyaGrubu.querySelectorAll('.veya-grubu-ekle').forEach(function(btn) {
            btn.setAttribute('data-target-id', 'if-bloklar-container-sol_' + sayac); // Ã¶rnek sol iÃ§in
        });
    });
}


</script>

<!-- silme grup Ã§arpÄ± butonlarÄ± -->
<script>
$(document).on('click', '.sil-btn', function(e) {
    e.preventDefault();

    // Hangi grubu sileceÄŸiz? En yakÄ±n parent .ve-grubu
    var grup = $(this).closest('.ve-grubu, .veya-grubu');
    if (grup.length) {
        grup.remove();
    }

    // EÄŸer id gÃ¼ncellemek istiyorsan ana container'Ä± bul ve gÃ¼ncelle:
    var anaContainer = grup.closest('.pre-buy-bolumu, #inside_buy_container, #after_sell_container');
    if (anaContainer.length) {
        guncelleIfBlokIdleri('#' + anaContainer.attr('id'));
    }
});

</script>







{% endblock %}
