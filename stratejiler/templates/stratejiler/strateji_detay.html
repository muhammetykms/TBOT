{% extends "tepe.html" %}

{% block title %}
T-ERP Stratejiler
{% endblock %}

{% load static %}
{% load custom_filters %}


{% block sayfabasligi %}

{% endblock %}

{% block sagustmap %}
      <li class="breadcrumb-item"><a href="{% url 'home' %}">İŞLEM AÇ</a></li>

{% endblock %}



{% block content %}

    <h1><b>STRATEJİ DETAY!</b></h1>

<div class="card card-primary">
  <div class="card-header">
    <h3 class="card-title"><b>İncelenen Strateji: {{ strateji.adi }}</b></h3>
  </div>
  <!-- /.card-header -->
  <div class="card-body">
    <table id="example1" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th scope="col"style="text-align: center;"><b>Strateji</b></th>
          <th scope="col"style="text-align: center;"><b>Durumu</b></th>
          <th scope="col"style="text-align: center;"><b>Buy Şartı</b></th>
          <th scope="col"style="text-align: center;"><b>HAB</b></th>
          <th scope="col"style="text-align: center;"><b>Sell Şartı</b></th>
          <th scope="col"style="text-align: center;"><b>HAS</b></th>
          <th scope="col" style="text-align: center;"><b>Düzenle</b></th>
        </tr>
      </thead>
      <tbody>
      <tr>          
          <td>Strateji&nbsp;:&emsp;{{ strateji.adi }}<br> Açıklaması&nbsp;:<br>{{ strateji.aciklama }}</td>
          <td style="text-align: center;">
            {% if strateji.aktif_mi %}
              <span class="badge bg-success">Aktif</span>
            {% else %}
              <span class="badge bg-danger">Pasif</span>
            {% endif %}
          </td>
          <td>  <b style="color: rgb(0, 173, 0);"> Buy Şartları: </b>
            {% for kosul in al_kosullari %}
              {% if kosul.strateji_id == strateji.id %}
                <br>{{ kosul.ifade|replace_gt_with_symbol }}
              {% endif %}
            {% endfor %}
          </td>
<td>
  <b style="color: rgb(220, 140, 0);"> Hold After Buy: </b>
</td>
        
          <td> <b style="color: rgb(245, 0, 0);"> Sell Şartları: </b>
            {% for kosul in sat_kosullari %}
              {% if kosul.strateji_id == strateji.id %} 
                <br>{{ kosul.ifade|replace_gt_with_symbol }}
              {% endif %} 
            {% endfor %}
          </td>
<td>
  <b style="color: rgb(220, 140, 0);"> Hold After Sell: </b>
</td>

          <td style="text-align: right; display: inline-block;">
            <a href="{% url 'stratejiler:strateji_kosulu_ekle' strateji.id %}" class="btn btn-warning">
              <b>
                <img src="{% static 'dist/img/short-position.png' %}" alt="mumlar" height="40" width="40" class="ml-1 mr-1">
                KOŞUL EKLE
                <img src="{% static 'dist/img/long-position.png' %}" alt="mumlar" height="40" width="40" class="ml-1 mr-1">
              </b>
            </a>
          </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>Genel Mantıksal Strateji İfadesi</h4>
    </div>
    <div class="card-body">
        <pre style="color: aliceblue;">{{ genel_ifade|safe }}</pre>  {# Genel ifadeyi buraya yazdırıyoruz #}
    </div>
</div>




<div class="card card-info">
  <div class="card-header">
    <h3 class="card-title"><b>Koşulları Birbirine Bağla</b></h3> 
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-5">
        <select class="form-control" id="kosul1" name="kosul1">
          <option value="0">Koşul Seçiniz</option>
          {% for kosul in al_kosullari %}
            {% if kosul.strateji_id == strateji.id %}
              <option value="{{ kosul.id }}">{{ kosul.ifade|replace_gt_with_symbol }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <select class="form-control" id="islem_operator" name="islem_operator">
          {% for x in operatorler %}
          <option value="{{x.id}}">{{x.operator_adi}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-5">
        <select class="form-control" id="kosul2" name="kosul2">
          <option value="0">Koşul Seçiniz</option>
          {% for kosul in al_kosullari %}
            {% if kosul.strateji_id == strateji.id %}
              <option value="{{ kosul.id }}">{{ kosul.ifade|replace_gt_with_symbol }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <button class="btn btn-info" id="kosullari-birlestir">Bağla</button>
      </div>
    </div>
  </div>
</div>

<div class="card card-success">
  <div class="card-header">
    <h3 class="card-title"><b>Strateji  AL (BUY) Koşulları</b></h3>
  </div>
  <!-- /.card-header -->
  <div class="card-body">
    <table id="example2" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th scope="col"style="text-align: center;"><b>Koşul_ID</b></th>
          <th scope="col"style="text-align: center;"><b>Şart</b></th>
          <th scope="col"style="text-align: center;"><b>Sıra</b></th>
          <th scope="col"style="text-align: center;"><b>Şart Tipi</b></th>
          <th scope="col"style="text-align: center;"><b>İlk İndikator</b></th>
          <th>And Bağı</th>
          <th>OR Bağı</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
{% for kosul in al_kosullari %}
    {% if kosul.strateji_id == strateji.id %}
        <tr>
            <td>{{ kosul.id }}</td>
            <td>
                <b style="color: rgb(0, 173, 0);"> Buy Şartları: </b>
                <br> {{ kosul.ifade|replace_gt_with_symbol }}  {# Filtreyi kullanıyoruz #}
            </td>
            <td>{{ kosul.sira }}</td>
            <td>{{ kosul.islem_operator }}</td>

            <!-- StratejiKosulIndikator verilerine erişim -->
            <td>
                {% for indikator in kosul.kosul_indikatorleri.all %}
                    <b>İndikatör:</b> {{ indikator.indikator.adi }} <br>
                    <b>Çıktı:</b> {{ indikator.indikator_ciktisi.cikti_adi }} <br>
                    <b>PIM:</b> {{ indikator.parite_interval_market }} <br>
                    
                    {% for parametre in indikator.kosul_parametreleri.all %}
                        <b>Parametre:</b> {{ parametre.indikator_parametre.parametre_adi }} = {{ parametre.kullanici_degeri }} <br>
                    {% empty %}
                        <i>Parametre bulunamadı</i>
                    {% endfor %}
                {% empty %}
                    <i>İndikatör bulunamadı</i>
                {% endfor %}
            </td>

<td>
    {% if kosul.and_baglanti.kosullar.all %}
        <b>AND Bağlantıları:</b>
        <ul>
        {% for bagli_kosul in kosul.and_baglanti.kosullar.all %}
            <li>{{ bagli_kosul.ifade|replace_gt_with_symbol }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <i>Bağlantı yok</i>
    {% endif %}
</td>

<td>
    {% if kosul.or_baglanti.kosullar.all %}
        <b>OR Bağlantıları:</b>
        <ul>
        {% for bagli_kosul in kosul.or_baglanti.kosullar.all %}
            <li>{{ bagli_kosul.ifade|replace_gt_with_symbol }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <i>Bağlantı yok</i>
    {% endif %}
</td>


            <!-- AJAX ile Koşul Silme Butonu -->
            <td>
                <button class="btn btn-danger sil-kosul" data-kosul-id="{{ kosul.id }}">Sil</button>
            </td>
        </tr>
    {% endif %}
{% endfor %}

      </tbody>
    </table>
  </div>
</div>


<div class="card card-danger">
  <div class="card-header">
    <h3 class="card-title"><b>Strateji  SAT (SELL) Koşulları</b></h3>
  </div>
  <!-- /.card-header -->
  <div class="card-body">
    <table id="example3" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th scope="col"style="text-align: center;"><b>Koşul_ID</b></th>
          <th scope="col"style="text-align: center;"><b>Şart</b></th>
          <th scope="col"style="text-align: center;"><b>Sıra</b></th>
          <th scope="col"style="text-align: center;"><b>Şart Tipi</b></th>
          <th scope="col"style="text-align: center;"><b>İlk İndikator</b></th>
          <th>And Bağı</th>
          <th>OR Bağı</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
{% for kosul in sat_kosullari %}
    {% if kosul.strateji_id == strateji.id %}
        <tr>
            <td>{{ kosul.id }}</td>
            <td>
                <b style="color: rgb(0, 173, 0);"> Buy Şartları: </b>
                <br> {{ kosul.ifade|replace_gt_with_symbol }}  {# Filtreyi kullanıyoruz #}
            </td>
            <td>{{ kosul.sira }}</td>
            <td>{{ kosul.islem_operator }}</td>

            <!-- StratejiKosulIndikator verilerine erişim -->
            <td>
                {% for indikator in kosul.kosul_indikatorleri.all %}
                    <b>İndikatör:</b> {{ indikator.indikator.adi }} <br>
                    <b>Çıktı:</b> {{ indikator.indikator_ciktisi.cikti_adi }} <br>
                    <b>PIM:</b> {{ indikator.parite_interval_market }} <br>
                    
                    {% for parametre in indikator.kosul_parametreleri.all %}
                        <b>Parametre:</b> {{ parametre.indikator_parametre.parametre_adi }} = {{ parametre.kullanici_degeri }} <br>
                    {% empty %}
                        <i>Parametre bulunamadı</i>
                    {% endfor %}
                {% empty %}
                    <i>İndikatör bulunamadı</i>
                {% endfor %}
            </td>

                        <!-- AND Bağı -->
<td>
    {% if kosul.and_baglanti.kosullar.all %}
        <b>AND Bağlantıları:</b>
        <ul>
        {% for bagli_kosul in kosul.and_baglanti.kosullar.all %}
            <li>{{ bagli_kosul.ifade|replace_gt_with_symbol }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <i>Bağlantı yok</i>
    {% endif %}
</td>

<td>
    {% if kosul.or_baglanti.kosullar.all %}
        <b>OR Bağlantıları:</b>
        <ul>
        {% for bagli_kosul in kosul.or_baglanti.kosullar.all %}
            <li>{{ bagli_kosul.ifade|replace_gt_with_symbol }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <i>Bağlantı yok</i>
    {% endif %}
</td>


            <!-- AJAX ile Koşul Silme Butonu -->
            <td>
                <button class="btn btn-danger sil-kosul" data-kosul-id="{{ kosul.id }}">Sil</button>
            </td>
        </tr>
    {% endif %}
{% endfor %}

      </tbody>
    </table>
  </div>
</div>
{% endblock %}


{% block footer %}
<p>My custom footer for this page.</p>

<!-- jQuery -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables  & Plugins -->
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
<script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
<script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>

<script>
  $(function () {
    $("#example1").DataTable({
      "responsive": true, "lengthChange": false, "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

    $("#example2").DataTable({
      "responsive": true, "lengthChange": false, "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#example2_wrapper .col-md-6:eq(0)');

    $("#example3").DataTable({
      "responsive": true, "lengthChange": false, "autoWidth": false,
      "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
    }).buttons().container().appendTo('#example3_wrapper .col-md-6:eq(0)');


  });
</script>


<script>
  $(document).ready(function() {
      $(".sil-kosul").click(function() {
          let kosul_id = $(this).data("kosul-id");
          let btn = $(this);

          if (confirm("Bu koşulu silmek istediğinizden emin misiniz?")) {
              $.ajax({
                  type: "POST",
                  url: "{% url 'stratejiler:kosul_sil' %}",
                  data: {
                      "kosul_id": kosul_id,
                      "csrfmiddlewaretoken": "{{ csrf_token }}"
                  },
                  dataType: "json",
                  success: function(response) {
                      if (response.status === "success") {
                          alert(response.message);
                          btn.closest("tr").remove();  // Koşulu listeden kaldır
                      } else {
                          alert(response.message);
                      }
                  },
                  error: function() {
                      alert("Hata oluştu! Lütfen tekrar deneyin.");
                  }
              });
          }
      });
  });
</script>

<script>
  $(document).ready(function() {
      $("#kosullari-birlestir").click(function() {
          let kosul1 = $("#kosul1").val();
          let kosul2 = $("#kosul2").val();
          let operator = $("#islem_operator").val();

          if (kosul1 === "0" || kosul2 === "0") {
              alert("Lütfen iki koşul seçin!");
              return;
          }

          $.ajax({
              type: "POST",
              url: "{% url 'stratejiler:kosul_bagla' %}",
              data: {
                  "kosul1": kosul1,
                  "kosul2": kosul2,
                  "operator": operator,
                  "csrfmiddlewaretoken": "{{ csrf_token }}"
              },
              dataType: "json",
              success: function(response) {
                  if (response.status === "success") {
                      alert(response.message);
                      location.reload(); // Sayfayı yenileyerek bağlantıyı göster
                  } else {
                      alert("Hata: " + response.message);
                  }
              },
              error: function() {
                  alert("İşlem sırasında hata oluştu!");
              }
          });
      });
  });
</script>


{% endblock %}
